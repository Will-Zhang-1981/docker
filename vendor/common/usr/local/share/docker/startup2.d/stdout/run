#!/bin/sh
set -e
mkdir -p /run/stdout
pid_file=/etc/startup2.d/stdout/supervise/daemons
tail_file=/etc/startup2.d/stdout/supervise/tails
touch $pid_file
pids=

if [ -d /etc/stdout.d ] && [ "$(ls -A /etc/stdout.d)" ]; then
  for f in /etc/stdout.d/*; do
    if [ -f "$f" ]; then
      printf "%s\n" "$f" > $tail_file
    fi
  done

  while [ -f $tail_file ] && tails=$(cat $tail_file) && [ -n "$tails" ] && rm -rf $tail_file; do
    for f in $tails; do
      tail -qf "$f" 2>/dev/null &
      pid=$!
      if ! kill -0 $pid; then
        printf "%s\n" "$f" > $tail_file
      else
        pids=$pids" $pid"
        printf "%s\n" > $pid_file
      fi
    done

    if [ -f "$tail_file" ] && [ -n "$(cat $tail_file)" ]; then
      sleep 1
    fi
  done
else
  touch /etc/stdout.d/empty
  tail -qf /etc/stdout.d/empty
  echo $! > $pid_file
  pids=$pids" $pid"
fi

wait $pids
